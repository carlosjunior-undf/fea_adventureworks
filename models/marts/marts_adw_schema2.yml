# marts_schema.yml
# Documentação e testes de qualidade das dimensões, bridge e fato

version: 2

models:

  # ─────────────────────────────────────────
  # DIMENSÕES
  # ─────────────────────────────────────────
    # =====================================================
      # DIM_ADW__CUSTOMER2
    # =====================================================
  - name: dim_adw__customer2
    description: >
      Dimensão de clientes. Granularidade: um registro por cliente único (customerid).
      Inclui dados pessoais (nome, tipo) e endereço principal de entrega.
      Clientes do tipo "store" (storeid preenchido) não possuem dados de person_person,
      por isso campos como full_name, emailpromotion e country_name podem ser nulos.
    columns:
      - name: customer_sk
        description: "Surrogate key gerada via dbt_utils (hash de customerid)"
        tests:
          - unique
          - not_null
      - name: customerid
        description: "Chave natural do cliente"
        tests:
          - unique
          - not_null
      - name: persontype
        description: "Tipo da pessoa no sistema — nulo para clientes do tipo store"
        tests:
          - dbt_utils.not_accepted_values:
              arguments:
                values: ['XX', 'TEST']
      - name: full_name
        description: "Nome completo concatenado — nulo para clientes do tipo store"
      - name: city
        description: "Cidade do endereço principal do cliente"
        tests:
          - dbt_utils.not_accepted_values:
              arguments:
                values: ['Test City']
      - name: state_name
        description: "Nome do estado/província"
      - name: country_name
        description: "Nome do país — nulo quando o endereço não está vinculado"

    # =====================================================
      # DIM_ADW__PRODUCT2
    # =====================================================
  - name: dim_adw__product2
    description: >
      Dimensão de produtos. Granularidade: um registro por produto único (productid).
      Inclui hierarquia completa: produto → subcategoria → categoria.
    tests:
      # Preço de lista deve ser maior ou igual ao custo padrão
      - dbt_utils.expression_is_true:
          arguments:
            expression: "listprice >= standardcost"
      # Produto não pode ter data de fim de venda anterior à de início
      - dbt_utils.expression_is_true:
          arguments:
            expression: "sellenddate is null or sellenddate > sellstartdate"
      # Produto descontinuado deve ter sellenddate preenchida
      - dbt_utils.expression_is_true:
          arguments:
            expression: "discontinueddate is null or sellenddate is not null"
      # listprice não pode ser negativo
      - dbt_utils.expression_is_true:
          arguments:
            expression: "listprice >= 0"
      # standardcost não pode ser negativo
      - dbt_utils.expression_is_true:
          arguments:
            expression: "standardcost >= 0"
      # safetystocklevel deve ser positivo
      - dbt_utils.expression_is_true:
          arguments:
            expression: "safetystocklevel > 0"
    columns:
      - name: product_sk
        description: "Surrogate key gerada via dbt_utils (hash de productid)"
        tests:
          - unique
          - not_null
      - name: productid
        description: "Chave natural do produto"
        tests:
          - unique
          - not_null
      - name: product_name
        description: "Nome do produto"
        tests:
          - not_null
          - dbt_utils.not_accepted_values:
              arguments:
                values: ['Test Product', 'DELETE']
      - name: productnumber
        description: "Código único do produto"
        tests:
          - unique
          - not_null
      - name: listprice
        description: "Preço de tabela do produto"
        tests:
          - not_null
      - name: standardcost
        description: "Custo padrão de fabricação/aquisição"
        tests:
          - not_null
      - name: safetystocklevel
        description: "Nível mínimo de estoque de segurança"
        tests:
          - not_null
      - name: sellstartdate
        description: "Data de início de vigência de venda"
        tests:
          - not_null
      - name: subcategory_name
        description: "Nome da subcategoria — nulo para produtos sem subcategoria"
      - name: category_name
        description: "Nome da categoria — nulo para produtos sem subcategoria"

    # =====================================================
      # DIM_ADW__CREDITCARD2
    # =====================================================
  - name: dim_adw__creditcard2
    description: >
      Dimensão de cartões de crédito. Granularidade: um registro por cartão (creditcardid).
      O número do cartão é mascarado por segurança.
    tests:
      # Mês de expiração deve estar entre 1 e 12
      - dbt_utils.expression_is_true:
          arguments:
            expression: "expmonth >= 1 and expmonth <= 12"
      # Ano de expiração deve ser razoável
      - dbt_utils.expression_is_true:
          arguments:
            expression: "expyear >= 2000 and expyear <= 2040"
      # Data de expiração montada deve ser preenchida
      - dbt_utils.expression_is_true:
          arguments:
            expression: "expiration_date is not null"
    columns:
      - name: creditcard_sk
        description: "Surrogate key (hash de creditcardid)"
        tests:
          - unique
          - not_null
      - name: creditcardid
        description: "Chave natural do cartão"
        tests:
          - unique
          - not_null
      - name: cardtype
        description: "Tipo/bandeira do cartão (ex: Visa, MasterCard)"
        tests:
          - not_null
          - dbt_utils.not_accepted_values:
              arguments:
                values: ['Test']
      - name: cardnumber_masked
        description: "Número mascarado do cartão (somente últimos 4 dígitos visíveis)"
        tests:
          - not_null
      - name: expmonth
        description: "Mês de expiração do cartão"
        tests:
          - not_null
      - name: expyear
        description: "Ano de expiração do cartão"
        tests:
          - not_null
      - name: expiration_date
        description: "Data de expiração montada (primeiro dia do mês de vencimento)"
        tests:
          - not_null

    # =====================================================
      # DIM_ADW__SALESREASON2
    # =====================================================
  - name: dim_adw__salesreason2
    description: >
      Dimensão de motivos de venda. Granularidade: um registro por motivo único (salesreasonid).
      A relação N:N com pedidos é resolvida via bridge_adw__salesreason.
      Nota: 'Other' é um motivo legítimo na Adventure Works e não é tratado como inválido.
    columns:
      - name: salesreason_sk
        description: "Surrogate key (hash de salesreasonid)"
        tests:
          - unique
          - not_null
      - name: salesreasonid
        description: "Chave natural do motivo de venda"
        tests:
          - unique
          - not_null
      - name: salesreason_name
        description: "Descrição do motivo de venda"
        tests:
          - not_null
          - dbt_utils.not_accepted_values:
              arguments:
                values: ['Test']
      - name: reasontype
        description: "Tipo/categoria do motivo (ex: Marketing, Promotion, Other)"
        tests:
          - not_null
          - dbt_utils.not_accepted_values:
              arguments:
                values: ['Test']

    # =====================================================
      # DIM_ADW__STATUS2
    # =====================================================
  - name: dim_adw__status2
    description: >
      Dimensão estática de status dos pedidos.
      Domínio: 1=In Process, 2=Approved, 3=Backordered, 4=Rejected, 5=Shipped, 6=Cancelled.
    tests:
      # statusid deve estar no domínio esperado
      - dbt_utils.expression_is_true:
          arguments:
            expression: "statusid in (1, 2, 3, 4, 5, 6)"
      # status_group deve ter apenas os dois valores esperados
      - dbt_utils.expression_is_true:
          arguments:
            expression: "status_group in ('Open', 'Closed')"
      # Toda linha com status_group='Closed' deve ter statusid >= 4
      - dbt_utils.expression_is_true:
          arguments:
            expression: "status_group <> 'Closed' or statusid >= 4"
      # Toda linha com status_group='Open' deve ter statusid <= 3
      - dbt_utils.expression_is_true:
          arguments:
            expression: "status_group <> 'Open' or statusid <= 3"
    columns:
      - name: status_sk
        description: "Surrogate key (hash de statusid)"
        tests:
          - unique
          - not_null
      - name: statusid
        description: "Identificador numérico do status"
        tests:
          - unique
          - not_null
      - name: status_name
        description: "Descrição legível do status"
        tests:
          - not_null
      - name: status_group
        description: "Agrupamento do status: Open (em andamento) ou Closed (finalizado)"
        tests:
          - not_null

    # =====================================================
      # DIM_ADW__DATE2
    # =====================================================
  - name: dim_adw__date2
    description: >
      Dimensão calendário gerada via dbt_utils.date_spine.
      Cobre o período de 2000-01-01 a 2030-12-31.
      Granularidade: um registro por dia.
    tests:
      # year deve estar no intervalo coberto pelo date_spine
      - dbt_utils.expression_is_true:
          arguments:
            expression: "year >= 2000 and year <= 2030"
      # month_number deve estar entre 1 e 12
      - dbt_utils.expression_is_true:
          arguments:
            expression: "month_number >= 1 and month_number <= 12"
      # quarter deve estar entre 1 e 4
      - dbt_utils.expression_is_true:
          arguments:
            expression: "quarter >= 1 and quarter <= 4"
      # day_of_week deve estar entre 1 e 7
      - dbt_utils.expression_is_true:
          arguments:
            expression: "day_of_week >= 1 and day_of_week <= 7"
      # day_of_month deve estar entre 1 e 31
      - dbt_utils.expression_is_true:
          arguments:
            expression: "day_of_month >= 1 and day_of_month <= 31"
      # week_of_year deve estar entre 1 e 53
      - dbt_utils.expression_is_true:
          arguments:
            expression: "week_of_year >= 1 and week_of_year <= 53"
      # year_month deve ter 7 caracteres (yyyy-MM)
      - dbt_utils.expression_is_true:
          arguments:
            expression: "length(year_month) = 7"
      # first_day_of_month deve ser sempre dia 1
      - dbt_utils.expression_is_true:
          arguments:
            expression: "day(first_day_of_month) = 1"
      # first_day_of_month não pode ser posterior a last_day_of_month
      - dbt_utils.expression_is_true:
          arguments:
            expression: "first_day_of_month <= last_day_of_month"
    columns:
      - name: date_sk
        description: "Surrogate key (hash de full_date)"
        tests:
          - unique
          - not_null
      - name: full_date
        description: "Data completa no formato DATE"
        tests:
          - unique
          - not_null
      - name: year
        description: "Ano (ex: 2011)"
        tests:
          - not_null
      - name: quarter
        description: "Trimestre (1–4)"
        tests:
          - not_null
      - name: month_number
        description: "Mês numérico (1–12)"
        tests:
          - not_null
      - name: day_of_week
        description: "Dia da semana (1=Domingo, 7=Sábado)"
        tests:
          - not_null
      - name: day_of_month
        description: "Dia do mês (1–31)"
        tests:
          - not_null
      - name: week_of_year
        description: "Semana do ano (1–53)"
        tests:
          - not_null
      - name: year_month
        description: "Ano-Mês no formato yyyy-MM (ex: 2011-03)"
        tests:
          - not_null
      - name: year_quarter
        description: "Ano e trimestre no formato Qn yyyy (ex: Q1 2011)"
        tests:
          - not_null
      - name: is_weekday
        description: "true = dia útil (seg–sex); false = fim de semana"
        tests:
          - not_null

  # ─────────────────────────────────────────
  # BRIDGE
  # ─────────────────────────────────────────
    # =====================================================
      # BRIDGE_ADW__SALESREASON2
    # =====================================================
  - name: bridge_adw__salesreason2
    description: >
      Tabela bridge para a relação N:N entre fct_adw__sales e dim_adw__salesreason.
      Granularidade: uma linha por combinação salesorderid + salesreasonid.
    tests:
      # Garante que salesorderid e salesreason_sk nunca são nulos simultaneamente
      - dbt_utils.expression_is_true:
          arguments:
            expression: "salesorderid is not null and salesreason_sk is not null"
    columns:
      - name: bridge_sk
        description: "Surrogate key da bridge (hash de salesorderid + salesreasonid)"
        tests:
          - unique
          - not_null
      - name: salesorderid
        description: "Chave natural do pedido — FK para fct_adw__sales"
        tests:
          - not_null
      - name: salesreason_sk
        description: "FK para dim_adw__salesreason"
        tests:
          - not_null

  # ─────────────────────────────────────────
  # FATO
  # ─────────────────────────────────────────
    # =====================================================
      # FACT_ADW__SALES2
    # =====================================================
  - name: fct_adw__sales2
    description: >
      Tabela fato central de vendas da Adventure Works.
      Granularidade: uma linha por linha de pedido (salesorderid + salesorderdetailid).
      Conecta todas as dimensões via surrogate keys.
      Para análise por motivo de venda, use a bridge_adw__salesreason.
    tests:
      # Receita bruta deve ser igual a orderqty * unitprice (tolerância de $0,01)
      - dbt_utils.expression_is_true:
          arguments:
            expression: "abs(gross_revenue - (orderqty * unitprice)) < 1"
      # Desconto deve ser igual a orderqty * unitprice * unitpricediscount
      - dbt_utils.expression_is_true:
          arguments:
            expression: "abs(discount_amount - (orderqty * unitprice * unitpricediscount)) < 1"
      # Receita líquida deve ser igual a gross_revenue - discount_amount
      - dbt_utils.expression_is_true:
          arguments:
            expression: "abs(net_revenue - (gross_revenue - discount_amount)) < 1"
      # Receita líquida não pode ser maior que a receita bruta
      - dbt_utils.expression_is_true:
          arguments:
            expression: "net_revenue <= gross_revenue"
      # Data de envio deve ser posterior ou igual à data do pedido
      - dbt_utils.expression_is_true:
          arguments:
            expression: "shipdate is null or shipdate >= orderdate"
      # Data prevista deve ser posterior ou igual à data do pedido
      - dbt_utils.expression_is_true:
          arguments:
            expression: "duedate >= orderdate"
      # Desconto não pode superar a receita bruta
      - dbt_utils.expression_is_true:
          arguments:
            expression: "discount_amount <= gross_revenue"
      # orderqty deve ser positivo
      - dbt_utils.expression_is_true:
          arguments:
            expression: "orderqty > 0"
      # unitprice deve ser positivo
      - dbt_utils.expression_is_true:
          arguments:
            expression: "unitprice > 0"
      # unitpricediscount deve estar entre 0 e 1
      - dbt_utils.expression_is_true:
          arguments:
            expression: "unitpricediscount >= 0 and unitpricediscount <= 1"
      # gross_revenue deve ser positivo
      - dbt_utils.expression_is_true:
          arguments:
            expression: "gross_revenue > 0"
      # discount_amount não pode ser negativo
#      - dbt_utils.expression_is_true:
#          arguments:
#            expression: "discount_amount >= 0"
      # net_revenue não pode ser negativo
      - dbt_utils.expression_is_true:
          arguments:
            expression: "net_revenue >= 0"
    columns:
      - name: sales_sk
        description: "Surrogate key da fato (hash de salesorderid + salesorderdetailid)"
        tests:
          - unique
          - not_null
      - name: salesorderid
        description: "Chave natural do pedido (cabeçalho)"
        tests:
          - not_null
      - name: salesorderdetailid
        description: "Chave natural da linha do pedido"
        tests:
          - unique
          - not_null
      - name: customer_sk
        description: "FK para dim_adw__customer"
        tests:
          - not_null
      - name: product_sk
        description: "FK para dim_adw__product"
        tests:
          - not_null
      - name: status_sk
        description: "FK para dim_adw__status"
        tests:
          - not_null
      - name: order_date_sk
        description: "FK para dim_adw__date (data do pedido)"
        tests:
          - not_null
      - name: creditcard_sk
        description: "FK para dim_adw__creditcard — nulo para pedidos sem cartão"
      - name: ship_date_sk
        description: "FK para dim_adw__date (data de envio) — nulo se ainda não enviado"
      - name: due_date_sk
        description: "FK para dim_adw__date (data prevista de entrega)"
        tests:
          - not_null
      - name: primary_salesreason_sk
        description: "FK para dim_adw__salesreason (motivo primário). Para análise completa usar bridge_adw__salesreason"
      - name: orderqty
        description: "Quantidade de itens comprados na linha do pedido"
        tests:
          - not_null
      - name: unitprice
        description: "Preço unitário do produto no momento da venda"
        tests:
          - not_null
      - name: unitpricediscount
        description: "Percentual de desconto aplicado (0.0 a 1.0)"
        tests:
          - not_null
      - name: gross_revenue
        description: "Receita bruta = orderqty * unitprice"
        tests:
          - not_null
      - name: discount_amount
        description: "Valor do desconto = orderqty * unitprice * unitpricediscount"
      - name: net_revenue
        description: "Receita líquida = gross_revenue - discount_amount"
        tests:
          - not_null
      - name: orderdate
        description: "Data em que o pedido foi realizado"
        tests:
          - not_null