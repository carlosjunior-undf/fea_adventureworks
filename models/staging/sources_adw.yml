# sources.yml
# Definição e testes das fontes brutas da Adventure Works
# Alinhado com as perguntas de negócio A–F após reestruturação dos modelos.
# Testes mantidos apenas para campos efetivamente usados nos marts finais.

version: 2

sources:
  # ─────────────────────────────────────────
  # ADW_PERSON
  # ─────────────────────────────────────────
  - name: adw_person
    description: "Schema de pessoas e endereços da Adventure Works"
    database: "fea_academy"
    schema: adventure_works
    tables:

      - name: person_address
        description: "Endereços físicos — city, state e country usados na dim_adw__customer"
        columns:
          - name: addressid
            description: "PK do endereço"
            tests:
              - unique
              - not_null
          - name: city
            description: "Cidade"
            tests:
              - not_null
          - name: stateprovinceid
            description: "FK para person_stateprovince"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('adw_person', 'person_stateprovince')
                    field: stateprovinceid

      - name: person_businessentityaddress
        description: "Vínculo entre entidade e endereço — usado para obter o endereço do cliente"
        columns:
          - name: businessentityid
            description: "FK para person_person"
            tests:
              - not_null
          - name: addressid
            description: "FK para person_address"
            tests:
              - not_null
          - name: addresstypeid
            description: "Tipo do endereço — usado para ordenar e pegar o primeiro"
            tests:
              - not_null

      - name: person_countryregion
        description: "Países e regiões — name usado como country_name na dim_adw__customer"
        columns:
          - name: countryregioncode
            description: "Código ISO do país (PK) — 1 registro com valor nulo na fonte"
            tests:
              - unique
          - name: name
            description: "Nome do país"
            tests:
              - not_null

      - name: person_person
        description: "Dados pessoais — firstname, middlename, lastname usados no full_name da dim_adw__customer"
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "firstname is not null or lastname is not null"
        columns:
          - name: businessentityid
            description: "PK da entidade de negócio"
            tests:
              - unique
              - not_null
          - name: persontype
            description: "Tipo da pessoa"
            tests:
              - not_null
          - name: firstname
            description: "Primeiro nome"
          - name: lastname
            description: "Sobrenome"

      - name: person_stateprovince
        description: "Estados e províncias — name usado como state_name na dim_adw__customer"
        columns:
          - name: stateprovinceid
            description: "PK do estado/província"
            tests:
              - unique
              - not_null
          - name: countryregioncode
            description: "FK para person_countryregion"
            tests:
              - not_null
              - dbt_utils.relationships_where:
                  arguments:
                    to: source('adw_person', 'person_countryregion')
                    field: countryregioncode
                    from_condition: "isonlystateprovinceflag = true"
          - name: name
            description: "Nome do estado/província"
            tests:
              - not_null

  # ─────────────────────────────────────────
  # ADW_PRODUCTION
  # ─────────────────────────────────────────
  - name: adw_production
    description: "Schema de produção e produtos da Adventure Works"
    database: "fea_academy"
    schema: adventure_works
    tables:

      - name: production_product
        description: "Catálogo de produtos — product_name, color, listprice usados na dim_adw__product"
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "listprice >= 0"
        columns:
          - name: productid
            description: "PK do produto"
            tests:
              - unique
              - not_null
          - name: name
            description: "Nome do produto"
            tests:
              - not_null
              - dbt_utils.not_accepted_values:
                  arguments:
                    values: ['Test Product', 'DELETE']
          - name: listprice
            description: "Preço de tabela"
            tests:
              - not_null

      - name: production_productcategory
        description: "Categorias de produto — name usado como category_name na dim_adw__product"
        columns:
          - name: productcategoryid
            description: "PK da categoria"
            tests:
              - unique
              - not_null
          - name: name
            description: "Nome da categoria"
            tests:
              - not_null

      - name: production_productsubcategory
        description: "Subcategorias — name usado como subcategory_name na dim_adw__product"
        columns:
          - name: productsubcategoryid
            description: "PK da subcategoria"
            tests:
              - unique
              - not_null
          - name: productcategoryid
            description: "FK para production_productcategory"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('adw_production', 'production_productcategory')
                    field: productcategoryid
          - name: name
            description: "Nome da subcategoria"
            tests:
              - not_null

  # ─────────────────────────────────────────
  # ADW_SALES
  # ─────────────────────────────────────────
  - name: adw_sales
    description: "Schema de vendas da Adventure Works"
    database: "fea_academy"
    schema: adventure_works
    tables:

      - name: sales_creditcard
        description: "Cartões de crédito — apenas cardtype é usado na dim_adw__creditcard"
        columns:
          - name: creditcardid
            description: "PK do cartão"
            tests:
              - unique
              - not_null
          - name: cardtype
            description: "Tipo/bandeira do cartão"
            tests:
              - not_null
              - dbt_utils.not_accepted_values:
                  arguments:
                    values: ['Test']

      - name: sales_customer
        description: "Clientes — customerid e personid usados na dim_adw__customer"
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "personid is not null or storeid is not null"
        columns:
          - name: customerid
            description: "PK do cliente"
            tests:
              - unique
              - not_null
          - name: personid
            description: "FK para person_person — nulo para clientes do tipo store"
            tests:
              - dbt_utils.relationships_where:
                  arguments:
                    to: source('adw_person', 'person_person')
                    field: businessentityid
                    from_condition: "personid is not null"

      - name: sales_salesorderheader
        description: >
          Cabeçalho dos pedidos — salesorderid usado na dim_adw__order,
          customerid, creditcardid, status, orderdate usados na fct_adw__sales.
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "shipdate is null or shipdate >= orderdate"
          - dbt_utils.expression_is_true:
              arguments:
                expression: "duedate >= orderdate"
          - dbt_utils.expression_is_true:
              arguments:
                expression: "status in (1, 2, 3, 4, 5, 6)"
        columns:
          - name: salesorderid
            description: "PK do pedido"
            tests:
              - unique
              - not_null
          - name: customerid
            description: "FK para sales_customer"
            tests:
              - not_null
              - dbt_utils.relationships_where:
                  arguments:
                    to: source('adw_sales', 'sales_customer')
                    field: customerid
                    from_condition: "status <> 4"
          - name: status
            description: "Status do pedido (1–6)"
            tests:
              - not_null
          - name: orderdate
            description: "Data do pedido"
            tests:
              - not_null
          - name: creditcardid
            description: "FK para sales_creditcard — nulo para pedidos sem cartão"
            tests:
              - dbt_utils.relationships_where:
                  arguments:
                    to: source('adw_sales', 'sales_creditcard')
                    field: creditcardid
                    from_condition: "creditcardid is not null"

      - name: sales_salesorderdetail
        description: >
          Linhas de detalhe dos pedidos — grain da fct_adw__sales.
          orderqty, unitprice e unitpricediscount usados no cálculo das métricas.
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "orderqty > 0"
          - dbt_utils.expression_is_true:
              arguments:
                expression: "unitprice > 0"
          - dbt_utils.expression_is_true:
              arguments:
                expression: "unitpricediscount >= 0 and unitpricediscount <= 1"
          - dbt_utils.expression_is_true:
              arguments:
                expression: "orderqty * unitprice > 0"
        columns:
          - name: salesorderdetailid
            description: "PK da linha de detalhe"
            tests:
              - unique
              - not_null
          - name: salesorderid
            description: "FK para sales_salesorderheader"
            tests:
              - not_null
              - dbt_utils.relationships_where:
                  arguments:
                    to: source('adw_sales', 'sales_salesorderheader')
                    field: salesorderid
                    from_condition: "salesorderdetailid is not null"
          - name: productid
            description: "FK para production_product"
            tests:
              - not_null
              - dbt_utils.relationships_where:
                  arguments:
                    to: source('adw_production', 'production_product')
                    field: productid
                    from_condition: "orderqty > 0"
          - name: orderqty
            description: "Quantidade comprada na linha"
            tests:
              - not_null
          - name: unitprice
            description: "Preço unitário cobrado"
            tests:
              - not_null
          - name: unitpricediscount
            description: "Percentual de desconto (0.0 a 1.0)"
            tests:
              - not_null

      - name: sales_salesorderheadersalesreason
        description: "Mapeamento N:N entre pedido e motivo — base da bridge_adw__salesreason"
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "salesorderid is not null and salesreasonid is not null"
        columns:
          - name: salesorderid
            description: "FK para sales_salesorderheader"
            tests:
              - not_null
              - dbt_utils.relationships_where:
                  arguments:
                    to: source('adw_sales', 'sales_salesorderheader')
                    field: salesorderid
                    from_condition: "salesreasonid is not null"
          - name: salesreasonid
            description: "FK para sales_salesreason"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('adw_sales', 'sales_salesreason')
                    field: salesreasonid

      - name: sales_salesreason
        description: "Motivos de venda — salesreason_name e reasontype usados na dim_adw__salesreason"
        columns:
          - name: salesreasonid
            description: "PK do motivo"
            tests:
              - unique
              - not_null
          - name: name
            description: "Nome do motivo — 'Other' é legítimo na Adventure Works"
            tests:
              - not_null
              - dbt_utils.not_accepted_values:
                  arguments:
                    values: ['Test']
          - name: reasontype
            description: "Tipo do motivo (ex: Marketing, Promotion, Other)"
            tests:
              - not_null